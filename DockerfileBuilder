FROM gradle:jdk19 AS builder
WORKDIR /app

COPY . /app/

RUN gradle clean shadowJar

FROM centos:latest

WORKDIR /app

ENV CHROME_VERSION="119.0.6045.105"

ENV JAVA_HOME="/usr/java/jdk-19/"

RUN sed -i 's/mirrorlist/#mirrorlist/g' /etc/yum.repos.d/CentOS-*
RUN sed -i 's|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g' /etc/yum.repos.d/CentOS-*

RUN yum update -y

# https://pkgs.alpinelinux.org/packages?name=chromium&branch=v3.12
# https://github.com/puppeteer/puppeteer/blob/v5.5.0/docs/api.md
RUN yum install -y wget curl

RUN yum -y update && yum clean all
RUN yum -y install epel-release && yum clean all
RUN yum -y install chromium nss freetype harfbuzz ca-certificates && yum clean all

ENV PUPPETEER_DOCKER true

ENV NODE_VERSION "v21.2.0"
ENV NODE_DISTRO "linux-x64"

RUN curl --silent --location https://dl.yarnpkg.com/rpm/yarn.repo | tee /etc/yum.repos.d/yarn.repo
RUN yum install -y yarn

RUN wget "https://nodejs.org/dist/${NODE_VERSION}/node-${NODE_VERSION}-${NODE_DISTRO}.tar.xz"
RUN mkdir -p /usr/local/lib/nodejs

RUN tar -xJvf "node-${NODE_VERSION}-${NODE_DISTRO}.tar.xz" -C /usr/local/lib/nodejs
RUN rm node-${NODE_VERSION}-${NODE_DISTRO}.tar.xz
ENV PATH="/usr/local/lib/nodejs/node-${NODE_VERSION}-${NODE_DISTRO}/bin:${PATH}"

ENV PATH="$PATH:$JAVA_HOME/bin"

RUN mkdir -p "$JAVA_HOME"
RUN wget https://download.java.net/java/GA/jdk19.0.1/afdd2e245b014143b62ccb916125e3ce/10/GPL/openjdk-19.0.1_linux-x64_bin.tar.gz
RUN tar xvf openjdk-19.0.1_linux-x64_bin.tar.gz
RUN mv jdk-19.0.1/* "$JAVA_HOME"
RUN rm -rf jdk-19.0.1

COPY --from=builder /app/build/libs/pdf-generator-1.0.0-all.jar /app.jar

